{% extends 'accounts/base.html' %}

{% block title %}{{ title }} - Banking Platform{% endblock %}

{% block extra_css %}
<style>
    .transaction-card {
        transition: all 0.2s ease;
        border: 1px solid var(--bs-border-color);
    }
    .transaction-card:hover {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transform: translateY(-1px);
    }
    .amount-credit {
        color: var(--bs-success);
        font-weight: 600;
    }
    .amount-debit {
        color: var(--bs-danger);
        font-weight: 600;
    }
    .balance-display {
        font-family: var(--bs-font-monospace);
        font-size: 0.875rem;
    }
    .transaction-type-deposit {
        background: linear-gradient(135deg, var(--bs-success), #20c997);
    }
    .transaction-type-withdrawal {
        background: linear-gradient(135deg, var(--bs-danger), #fd7e14);
    }
    .transaction-type-transfer-in {
        background: linear-gradient(135deg, var(--bs-info), #6f42c1);
    }
    .transaction-type-transfer-out {
        background: linear-gradient(135deg, var(--bs-warning), #fd7e14);
    }
    .filter-collapse {
        background: var(--bs-light);
        border-radius: var(--bs-border-radius);
    }
    .summary-metric {
        border-left: 4px solid var(--bs-primary);
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(13, 110, 253, 0.05));
    }
    @media (max-width: 767.98px) {
        .table-responsive-stack {
            display: none;
        }
        .mobile-cards {
            display: block;
        }
    }
    @media (min-width: 768px) {
        .table-responsive-stack {
            display: block;
        }
        .mobile-cards {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-primary text-white">
                <div class="card-body py-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-history fa-2x opacity-75"></i>
                        </div>
                        <div>
                            <h1 class="h3 mb-1 fw-bold">{{ title }}</h1>
                            <p class="mb-0 opacity-90">View and manage your transaction history</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Summary -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm summary-metric h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-credit-card text-primary fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 fw-normal">Account Number</h6>
                            <p class="h6 font-monospace mb-0 text-dark">{{ bank_account.account_number }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm summary-metric h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-wallet text-success fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 fw-normal">Current Balance</h6>
                            <p class="h5 text-success mb-0 fw-bold">${{ bank_account.balance|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm summary-metric h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-chart-line text-info fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 fw-normal">Total Transactions</h6>
                            <p class="h5 text-info mb-0 fw-bold">{{ total_transactions }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3 transaction-type-deposit" style="width: 60px; height: 60px;">
                        <i class="fas fa-plus text-white fa-lg"></i>
                    </div>
                    <h6 class="text-success fw-semibold mb-1">Deposits</h6>
                    <p class="h5 mb-0 fw-bold">{{ total_deposits }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3 transaction-type-withdrawal" style="width: 60px; height: 60px;">
                        <i class="fas fa-minus text-white fa-lg"></i>
                    </div>
                    <h6 class="text-danger fw-semibold mb-1">Withdrawals</h6>
                    <p class="h5 mb-0 fw-bold">{{ total_withdrawals }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3 transaction-type-transfer-out" style="width: 60px; height: 60px;">
                        <i class="fas fa-arrow-up text-white fa-lg"></i>
                    </div>
                    <h6 class="text-warning fw-semibold mb-1">Transfers Sent</h6>
                    <p class="h5 mb-0 fw-bold">{{ total_transfers_sent }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3 transaction-type-transfer-in" style="width: 60px; height: 60px;">
                        <i class="fas fa-arrow-down text-white fa-lg"></i>
                    </div>
                    <h6 class="text-info fw-semibold mb-1">Transfers Received</h6>
                    <p class="h5 mb-0 fw-bold">{{ total_transfers_received }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pb-0">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="mb-0 fw-semibold">
                            <i class="fas fa-filter me-2 text-primary"></i>Filter Transactions
                        </h6>
                        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
                            <i class="fas fa-chevron-down me-1"></i>Toggle Filters
                        </button>
                    </div>
                </div>
                <div class="collapse show" id="filterCollapse">
                    <div class="card-body filter-collapse">
                        <form method="get" class="row g-3">
                            <!-- Transaction Type Filter -->
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    <select name="type" id="type" class="form-select">
                                        <option value="">All Types</option>
                                        <option value="deposit" {% if current_type == 'deposit' %}selected{% endif %}>Deposits</option>
                                        <option value="withdrawal" {% if current_type == 'withdrawal' %}selected{% endif %}>Withdrawals</option>
                                        <option value="transfer" {% if current_type == 'transfer' %}selected{% endif %}>Transfers</option>
                                    </select>
                                    <label for="type">Transaction Type</label>
                                </div>
                            </div>

                            <!-- Date Filter -->
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    <select name="date_filter" id="date_filter" class="form-select">
                                        <option value="">All Time</option>
                                        <option value="7days" {% if current_date_filter == '7days' %}selected{% endif %}>Last 7 Days</option>
                                        <option value="30days" {% if current_date_filter == '30days' %}selected{% endif %}>Last 30 Days</option>
                                        <option value="90days" {% if current_date_filter == '90days' %}selected{% endif %}>Last 90 Days</option>
                                    </select>
                                    <label for="date_filter">Date Range</label>
                                </div>
                            </div>

                            <!-- Custom Date Range -->
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    <input type="date" name="start_date" id="start_date" class="form-control" value="{{ current_start_date }}" placeholder="Start Date">
                                    <label for="start_date">Start Date</label>
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    <input type="date" name="end_date" id="end_date" class="form-control" value="{{ current_end_date }}" placeholder="End Date">
                                    <label for="end_date">End Date</label>
                                </div>
                            </div>

                            <!-- Amount Range -->
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    <input type="number" name="min_amount" id="min_amount" class="form-control" step="0.01" min="0" value="{{ current_min_amount }}" placeholder="0.00">
                                    <label for="min_amount">Min Amount ($)</label>
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    <input type="number" name="max_amount" id="max_amount" class="form-control" step="0.01" min="0" value="{{ current_max_amount }}" placeholder="No limit">
                                    <label for="max_amount">Max Amount ($)</label>
                                </div>
                            </div>

                            <!-- Filter Actions -->
                            <div class="col-lg-6 col-md-12">
                                <div class="d-flex gap-2 h-100 align-items-end">
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="fas fa-search me-2"></i>Apply Filters
                                    </button>
                                    <a href="{% url 'transactions:history' %}" class="btn btn-outline-secondary px-4">
                                        <i class="fas fa-times me-2"></i>Clear All
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>    <
!-- Transaction List -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center flex-wrap">
                    <h6 class="mb-0 fw-semibold">
                        <i class="fas fa-list me-2 text-primary"></i>Transaction History
                    </h6>
                    {% if page_obj.paginator.count > 0 %}
                        <div class="badge bg-light text-dark border">
                            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} transactions
                        </div>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if transaction_data %}
                        <!-- Desktop Table View -->
                        <div class="table-responsive-stack">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 fw-semibold">Date & Time</th>
                                            <th class="border-0 fw-semibold">Type</th>
                                            <th class="border-0 fw-semibold">Description</th>
                                            <th class="border-0 fw-semibold text-end">Amount</th>
                                            <th class="border-0 fw-semibold text-end">Balance After</th>
                                            <th class="border-0 fw-semibold">Reference</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in transaction_data %}
                                        <tr class="border-bottom">
                                            <td class="py-3">
                                                <div class="fw-semibold text-dark">{{ item.transaction.timestamp|date:"M d, Y" }}</div>
                                                <small class="text-muted">{{ item.transaction.timestamp|time:"g:i A" }}</small>
                                            </td>
                                            <td class="py-3">
                                                {% if item.transaction.transaction_type == 'deposit' %}
                                                    <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2">
                                                        <i class="fas fa-plus me-1"></i>Deposit
                                                    </span>
                                                {% elif item.transaction.transaction_type == 'withdrawal' %}
                                                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle px-3 py-2">
                                                        <i class="fas fa-minus me-1"></i>Withdrawal
                                                    </span>
                                                {% elif item.transaction.transaction_type == 'transfer' %}
                                                    {% if item.is_credit %}
                                                        <span class="badge bg-info-subtle text-info border border-info-subtle px-3 py-2">
                                                            <i class="fas fa-arrow-down me-1"></i>Transfer In
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-3 py-2">
                                                            <i class="fas fa-arrow-up me-1"></i>Transfer Out
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td class="py-3">
                                                <div class="fw-semibold text-dark">{{ item.description }}</div>
                                                {% if item.transaction.description %}
                                                    <small class="text-muted">{{ item.transaction.description }}</small>
                                                {% endif %}
                                            </td>
                                            <td class="py-3 text-end">
                                                {% if item.is_credit %}
                                                    <span class="amount-credit fw-bold">+${{ item.display_amount|floatformat:2 }}</span>
                                                {% else %}
                                                    <span class="amount-debit fw-bold">-${{ item.display_amount|floatformat:2 }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="py-3 text-end">
                                                {% if item.balance_after is not None %}
                                                    <span class="balance-display fw-semibold">${{ item.balance_after|floatformat:2 }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="py-3">
                                                <small class="font-monospace text-muted">{{ item.transaction.reference_number }}</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Mobile Card View -->
                        <div class="mobile-cards p-3">
                            {% for item in transaction_data %}
                            <div class="card transaction-card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            {% if item.transaction.transaction_type == 'deposit' %}
                                                <span class="badge bg-success-subtle text-success border border-success-subtle">
                                                    <i class="fas fa-plus me-1"></i>Deposit
                                                </span>
                                            {% elif item.transaction.transaction_type == 'withdrawal' %}
                                                <span class="badge bg-danger-subtle text-danger border border-danger-subtle">
                                                    <i class="fas fa-minus me-1"></i>Withdrawal
                                                </span>
                                            {% elif item.transaction.transaction_type == 'transfer' %}
                                                {% if item.is_credit %}
                                                    <span class="badge bg-info-subtle text-info border border-info-subtle">
                                                        <i class="fas fa-arrow-down me-1"></i>Transfer In
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                                                        <i class="fas fa-arrow-up me-1"></i>Transfer Out
                                                    </span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            {% if item.is_credit %}
                                                <div class="amount-credit fw-bold h6 mb-0">+${{ item.display_amount|floatformat:2 }}</div>
                                            {% else %}
                                                <div class="amount-debit fw-bold h6 mb-0">-${{ item.display_amount|floatformat:2 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <h6 class="card-title mb-2">{{ item.description }}</h6>
                                    {% if item.transaction.description %}
                                        <p class="card-text text-muted small mb-2">{{ item.transaction.description }}</p>
                                    {% endif %}
                                    
                                    <div class="row g-2 small text-muted">
                                        <div class="col-6">
                                            <strong>Date:</strong><br>
                                            {{ item.transaction.timestamp|date:"M d, Y" }}<br>
                                            {{ item.transaction.timestamp|time:"g:i A" }}
                                        </div>
                                        <div class="col-6 text-end">
                                            <strong>Balance After:</strong><br>
                                            {% if item.balance_after is not None %}
                                                <span class="balance-display">${{ item.balance_after|floatformat:2 }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-12 mt-2">
                                            <strong>Reference:</strong> 
                                            <span class="font-monospace">{{ item.transaction.reference_number }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-receipt fa-4x text-muted opacity-50"></i>
                            </div>
                            <h5 class="text-muted mb-3">No Transactions Found</h5>
                            <p class="text-muted mb-4">
                                {% if current_type or current_date_filter or current_start_date or current_end_date or current_min_amount or current_max_amount %}
                                    No transactions match your current filters. Try adjusting your search criteria.
                                {% else %}
                                    You haven't made any transactions yet. Start by making a deposit or transfer.
                                {% endif %}
                            </p>
                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                <a href="{% url 'transactions:deposit' %}" class="btn btn-success">
                                    <i class="fas fa-plus me-2"></i>Make Deposit
                                </a>
                                <a href="{% url 'transactions:transfer' %}" class="btn btn-primary">
                                    <i class="fas fa-exchange-alt me-2"></i>Transfer Money
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>    <!
-- Pagination -->
    {% if page_obj.has_other_pages %}
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="Transaction history pagination">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page=1" aria-label="First page">
                                    <i class="fas fa-angle-double-left me-1"></i>First
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous page">
                                    <i class="fas fa-angle-left me-1"></i>Previous
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active" aria-current="page">
                                    <span class="page-link fw-bold">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next page">
                                    Next<i class="fas fa-angle-right ms-1"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.paginator.num_pages }}" aria-label="Last page">
                                    Last<i class="fas fa-angle-double-right ms-1"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    {% endif %}    <
!-- Statement Download -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-download text-primary fa-lg me-3"></i>
                        <div>
                            <h6 class="mb-1 fw-semibold">Download Statement</h6>
                            <p class="mb-0 text-muted small">Export your transaction history in CSV or PDF format</p>
                        </div>
                    </div>
                    
                    <form method="get" class="row g-3 mb-3" id="downloadForm">
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="date" name="start_date" id="download_start_date" class="form-control" value="{{ current_start_date }}" placeholder="From Date">
                                <label for="download_start_date">From Date</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="date" name="end_date" id="download_end_date" class="form-control" value="{{ current_end_date }}" placeholder="To Date">
                                <label for="download_end_date">To Date</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-2 h-100 align-items-end">
                                <button type="button" class="btn btn-outline-success" onclick="downloadStatement('csv')">
                                    <i class="fas fa-file-csv me-2"></i>CSV
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="downloadStatement('pdf')">
                                    <i class="fas fa-file-pdf me-2"></i>PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="alert alert-info border-0 py-2 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Leave dates empty to download all transactions. Large statements may take a moment to generate.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="mb-3 fw-semibold">
                        <i class="fas fa-bolt text-primary me-2"></i>Quick Actions
                    </h6>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <a href="{% url 'transactions:deposit' %}" class="btn btn-success px-4">
                            <i class="fas fa-plus me-2"></i>Deposit
                        </a>
                        <a href="{% url 'transactions:withdrawal' %}" class="btn btn-danger px-4">
                            <i class="fas fa-minus me-2"></i>Withdraw
                        </a>
                        <a href="{% url 'transactions:transfer' %}" class="btn btn-primary px-4">
                            <i class="fas fa-exchange-alt me-2"></i>Transfer
                        </a>
                        <a href="{% url 'accounts:dashboard' %}" class="btn btn-outline-secondary px-4">
                            <i class="fas fa-home me-2"></i>Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}{% block
 extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-submit form when date filter changes
        const dateFilter = document.getElementById('date_filter');
        if (dateFilter) {
            dateFilter.addEventListener('change', function() {
                if (this.value) {
                    // Clear custom date inputs when using preset filters
                    document.getElementById('start_date').value = '';
                    document.getElementById('end_date').value = '';
                }
            });
        }

        // Clear date filter when custom dates are used
        const startDate = document.getElementById('start_date');
        const endDate = document.getElementById('end_date');
        
        if (startDate) {
            startDate.addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('date_filter').value = '';
                }
            });
        }
        
        if (endDate) {
            endDate.addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('date_filter').value = '';
                }
            });
        }

        // Format amount inputs
        const amountInputs = document.querySelectorAll('input[type="number"][step="0.01"]');
        amountInputs.forEach(function(input) {
            input.addEventListener('input', function(e) {
                let value = e.target.value;
                if (value && !isNaN(value)) {
                    // Ensure only 2 decimal places
                    const parts = value.split('.');
                    if (parts[1] && parts[1].length > 2) {
                        e.target.value = parseFloat(value).toFixed(2);
                    }
                }
            });
        });

        // Add loading state to filter form
        const filterForm = document.querySelector('form:not(#downloadForm)');
        if (filterForm) {
            filterForm.addEventListener('submit', function() {
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
                    submitBtn.disabled = true;
                }
            });
        }

        // Toggle filter collapse icon
        const filterToggle = document.querySelector('[data-bs-target="#filterCollapse"]');
        const filterCollapse = document.getElementById('filterCollapse');
        
        if (filterToggle && filterCollapse) {
            filterCollapse.addEventListener('show.bs.collapse', function() {
                filterToggle.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up');
            });
            
            filterCollapse.addEventListener('hide.bs.collapse', function() {
                filterToggle.querySelector('i').classList.replace('fa-chevron-up', 'fa-chevron-down');
            });
        }
    });

    // Download statement function
    function downloadStatement(format) {
        const form = document.getElementById('downloadForm');
        const startDate = form.querySelector('input[name="start_date"]').value;
        const endDate = form.querySelector('input[name="end_date"]').value;
        
        // Validate date range
        if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
            alert('Start date cannot be after end date.');
            return;
        }
        
        // Build URL with parameters
        let url = '';
        if (format === 'csv') {
            url = '{% url "transactions:download_csv_statement" %}';
        } else if (format === 'pdf') {
            url = '{% url "transactions:download_pdf_statement" %}';
        }
        
        const params = new URLSearchParams();
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        // Show loading state
        const buttons = form.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.disabled = true;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
            
            // Reset button after delay
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }, 3000);
        });
        
        // Create hidden iframe for download
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);
        
        // Remove iframe after delay
        setTimeout(() => {
            if (document.body.contains(iframe)) {
                document.body.removeChild(iframe);
            }
        }, 5000);
    }
</script>
{% endblock %}